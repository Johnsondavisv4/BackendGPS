FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
COPY nest-cli.json ./
COPY tsconfig*.json ./
COPY apps ./apps
COPY libs ./libs

RUN npm ci --legacy-peer-deps

# Build todos los servicios (asumiendo monorepo)
RUN npm run build:all

# --- Build args para secrets ---
ARG DB_HOST
ARG DB_PORT
ARG DB_USER
ARG DB_PASS
ARG DB_NAME
ARG DB_POOL_MODE

ARG PORT_CORE
ARG PORT_CLINICAL
ARG PORT_NUTRITION
ARG PORT_ODONTO
ARG PORT_PATIENT
ARG PORT_PHARMACY
ARG PORT_VACCINATION
ARG PORT_GATEWAY

ARG SCHEMA_CORE
ARG SCHEMA_CLINICAL
ARG SCHEMA_NUTRITION
ARG SCHEMA_ODONTO
ARG SCHEMA_PATIENT
ARG SCHEMA_PHARMACY
ARG SCHEMA_VACCINATION

# --- Variables de entorno para el contenedor ---
ENV DB_HOST=$DB_HOST \
    DB_PORT=$DB_PORT \
    DB_USER=$DB_USER \
    DB_PASS=$DB_PASS \
    DB_NAME=$DB_NAME \
    DB_POOL_MODE=$DB_POOL_MODE \
    PORT_CORE=$PORT_CORE \
    PORT_CLINICAL=$PORT_CLINICAL \
    PORT_NUTRITION=$PORT_NUTRITION \
    PORT_ODONTO=$PORT_ODONTO \
    PORT_PATIENT=$PORT_PATIENT \
    PORT_PHARMACY=$PORT_PHARMACY \
    PORT_VACCINATION=$PORT_VACCINATION \
    PORT_GATEWAY=$PORT_GATEWAY \
    SCHEMA_CORE=$SCHEMA_CORE \
    SCHEMA_CLINICAL=$SCHEMA_CLINICAL \
    SCHEMA_NUTRITION=$SCHEMA_NUTRITION \
    SCHEMA_ODONTO=$SCHEMA_ODONTO \
    SCHEMA_PATIENT=$SCHEMA_PATIENT \
    SCHEMA_PHARMACY=$SCHEMA_PHARMACY \
    SCHEMA_VACCINATION=$SCHEMA_VACCINATION

EXPOSE 3010

CMD ["npm", "run", "start:all"]